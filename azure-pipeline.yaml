trigger:
  branches:
    include:
      - main
      - feature*

pr:
  - master

pool:
  vmImage: 'windows-latest'

variables:
- group: TWPC.Shared

stages:

- stage: Dev
  displayName: 'Deploy Dev'
  variables:
  - group: TWPC.Dev
  - name: twpc.environment
    value: $(azure.environment)

  jobs:

  - deployment: 'Review_Infrastructure'
    environment: Dev
    condition: ne(variables['Build.SourceBranch'], 'refs/heads/master')
    strategy:
      runOnce:
        deploy:
          steps:
          - script: echo 'Pipeline running'
  #        - task: Pulumi@1
  #          displayName: 'Review Infrastructure'
  #          inputs:
  #            azureSubscription: $(azure.service.principal)
  #            command: "preview"
  #            cwd: $(pulumi.working.directory)
  #            stack: $(pulumi.stack.name)

  #- job: 'Review_Infrastructure'
  #  condition: ne(variables['Build.SourceBranch'], 'refs/heads/master')
  #  steps:
  #    - task: Pulumi@1
  #      displayName: 'Review Infrastructure'
  #      inputs:
  #        azureSubscription: $(azure.service.principal)
  #        command: "preview"
  #        cwd: $(pulumi.working.directory)
  #        stack: $(pulumi.stack.name)

  - job: 'Deploy_Infrastructure'
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')

  - job: 'Publish_Website'
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')
      
- stage: Test
  displayName: 'Deploy Test'
  variables:
  - group: TWPC.Test
  - name: twpc.environment
    value: $(azure.environment)

  jobs:
  - deployment: 'Review_Infrastructure'
    displayName: 'Review infrastructure'
    environment: Test
    condition: ne(variables['Build.SourceBranch'], 'refs/heads/master')

  #- job: 'Review_Infrastructure'
  #  condition: ne(variables['Build.SourceBranch'], 'refs/heads/master')
  #  steps:
  #  - task: Pulumi@1
  #    displayName: 'Review Infrastructure'
  #    inputs:
  #      azureSubscription: $(azure.service.principal)
  #      command: "preview"
  #      cwd: $(pulumi.working.directory)
  #      stack: $(pulumi.stack.name)

  - job: 'Deploy_Infrastructure'
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')

  - job: 'Publish_Website'
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')

- stage: Prod
  displayName: 'Deploy Prod'
  variables:
  - group: TWPC.Test
  - name: twpc.environment
    value: $(azure.environment)

  jobs:
  - deployment: 'Review_Infrastructure'
    displayName: 'Review Infrastructure'
    environment: Prod
    condition: ne(variables['Build.SourceBranch'], 'refs/heads/master')

  #- job: 'Review_Infrastructure'
  #  condition: ne(variables['Build.SourceBranch'], 'refs/heads/master')
  #  steps:
  #  - task: Pulumi@1
  #    displayName: 'Review Infrastructure'
  #    inputs:
  #      azureSubscription: $(azure.service.principal)
  #      command: "preview"
  #      cwd: $(pulumi.working.directory)
  #      stack: $(pulumi.stack.name)

  - job: 'Deploy_Infrastructure'
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')

  - job: 'Publish_Website'
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')
